<div class="assignments-card">
	<div class="assignments-header">
		<h2> Assignment</h2>
		<div>
			<button class="upload-btn" (click)="openCreate()">+ Create Assignment</button>
		</div>
	</div>

	<div class="divider"></div>

	<h3 style="margin: 0 0 16px 0; font-size: 18px; color: #111827; font-weight: 700;">Your Assignments</h3>

	<div class="assignments-list">
		<div class="assignment-row" *ngFor="let a of assignments; let i = index" [class.alt]="i % 2 === 1">
			<div class="left">
				<a class="title">{{ a.title }}</a>
				<div class="course">{{ a.description }}</div>
			</div>
			<div class="right">
				<div class="stats">0 <span class="stat-label">Submitted</span></div>
				<div class="due">Due: <span>{{ a.due }}</span></div>
				<button class="view-btn" (click)="openSubmissions(a)">View Submissions</button>

				<button class="view-btn" (click)="deleteAssignment(a.id)">Delete</button>
				<button class="view-btn" (click)="openFeedback(a)">Feedback</button>
			</div>
		</div>
		<div *ngIf="assignments.length === 0" class="muted">No assignments uploaded yet.</div>
	</div>

	<!-- Create Modal -->
	<div class="modal-overlay" *ngIf="showForm">
		<div class="modal">
			<div class="modal-header">
				<button class="close" (click)="clearForm(); showForm = false">✕</button>
			</div>
			<div class="modal-body">
				<form (ngSubmit)="submitAssignment(title.value, description.value, due.value)">
					<div class="field">
						<label class="label">Title *</label>
						<input #title type="text" required />
					</div>
					<div class="field">
						<label class="label">Due Date *</label>
						<input #due type="date" required />
					</div>
					<div class="field">
						<label class="label">Description</label>
						<textarea #description rows="6"></textarea>
					</div>
					<div class="field">
						<label class="label">File (optional)</label>
						<label class="file-label" for="assignmentFile">Choose File</label>
						<input id="assignmentFile" type="file" (change)="onFileSelected($event)" hidden />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn" (click)="clearForm(); showForm = false">Cancel</button>
						<button type="submit" class="btn primary">Create Assignment</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Feedback Modal -->
	<div class="modal-overlay" *ngIf="feedbackTarget">
		<div class="modal">
			<div class="modal-header">
				<h3>Feedback for: {{ feedbackTarget.title }}</h3>
				<button class="close" (click)="cancelFeedback()">✕</button>
			</div>
			<div class="modal-body">
				<div class="field">
					<label class="label">Feedback</label>
					<textarea [(ngModel)]="feedbackText" rows="6"></textarea>
				</div>
				<div class="modal-footer">
					<button class="btn" (click)="cancelFeedback()">Cancel</button>
					<button class="btn primary" (click)="saveFeedback()">Save Feedback</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Submissions Modal -->
	<div class="modal-overlay" *ngIf="submissionsTarget">
		<div class="modal">
			<div class="modal-header">
				<h3>Submissions for: {{ submissionsTarget.title }}</h3>
				<button class="close" (click)="closeSubmissions()">✕</button>
			</div>
			<div class="modal-body">
				<div *ngIf="submissionsTarget.submissions && submissionsTarget.submissions.length > 0; else noSubs">
					<div *ngFor="let s of submissionsTarget.submissions" style="border-bottom:1px solid #eee; padding:10px 0;">
						<div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
							<div>
								<strong>{{ s.studentName }}</strong>
								<div class="muted">Submitted: {{ s.submittedAt | date:'short' }}</div>
							</div>
							<div style="display:flex; gap:8px; align-items:center;">
								<button class="view-btn" *ngIf="s.fileDataUrl" (click)="downloadAttachment({fileDataUrl: s.fileDataUrl, fileName: s.fileName})">Download</button>
							</div>
						</div>
						<div style="margin-top:8px;">
							<label class="label">Feedback</label>
							<textarea [(ngModel)]="s.feedback" rows="3" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></textarea>
							<div style="display:flex; justify-content:flex-end; margin-top:8px; gap:8px;">
								<button class="btn" (click)="s.feedback = ''; saveSubmissionFeedback(s)">Clear</button>
								<button class="btn primary" (click)="saveSubmissionFeedback(s)">Save</button>
							</div>
						</div>
					</div>
				</div>
				<ng-template #noSubs>
					<p class="muted">No submissions for this assignment yet.</p>
				</ng-template>
			</div>
		</div>
	</div>
</div>