import { Component, OnInit } from '@angular/core';
import { Course, CourseService } from '../../../../services/course.service';
import { User, UserService } from '../../../../services/user.service';
import { Fee, FeeService} from '../../../../services/fee.service';

@Component({
  selector: 'app-user-management',
  templateUrl: './user-management.component.html',
  styleUrls: ['./user-management.component.css']
})
export class UserManagementComponent implements OnInit {
  users: User[] = [];
  
  courses: Course[] = [];
  departments: string[] = [];

  showForm = false;
  editing = false;
  currentAddRole: 'Admin' | 'Student' | 'Faculty' = 'Admin';
  tempUser: Partial<User> = {};
  searchTerm = '';
  roleFilter = 'Admin';
  loading = false;
  errorMessage = '';

  constructor(
    private courseService: CourseService, 
    private userService: UserService,
    private feeService: FeeService
  ) { }

  ngOnInit(): void {
    this.courseService.getCourses().subscribe({
      next: (courses) => {
        this.courses = courses;
        const deptSet = new Set<string>();
        this.courses.forEach(c => { if (c.department) deptSet.add(c.department); });
        this.departments = Array.from(deptSet);
      },
      error: (error) => {
        console.error('Error loading courses:', error);
      }
    });
    this.loadUsers();
  }

  loadUsers(): void {
    this.loading = true;
    this.errorMessage = '';
    this.userService.list().subscribe({
      next: (users: User[]) => {
        this.users = users;
        this.loading = false;
      },
      error: (err: any) => {
        console.error('Failed to load users', err);
        this.errorMessage = 'Failed to load users.';
        this.loading = false;
      }
    });
  }

  get filteredUsers(): User[] {
    const term = this.searchTerm.trim().toLowerCase();
    return this.users.filter(u => {
      const matchesTerm = !term || u.name.toLowerCase().includes(term) || u.email.toLowerCase().includes(term);
      const matchesRole = !this.roleFilter || u.roles.includes(this.roleFilter);
      return matchesTerm && matchesRole;
    });
  }

  getSubjectsDisplay(subjects?: string): string {
    if (!subjects) return '-';
    const course = this.courses.find(c => c.course_name === subjects);
    return course ? course.course_name : subjects;
  }

  get modalTitle(): string {
    if (this.editing) {
      const role = (this.tempUser.roles && this.tempUser.roles.length) ? this.tempUser.roles[0] : 'User';
      return `Edit ${role}`;
    }
    return `Add ${this.currentAddRole || this.roleFilter}`;
  }

  setRoleFilter(role: string): void {
    this.roleFilter = role;
  }

  openAddForRole(role: 'Admin' | 'Student' | 'Faculty'): void {
    this.editing = false;
    this.currentAddRole = role;
    this.tempUser = { name: '', email: '', roles: [role], status: 'Active' };
    if (role === 'Student') this.tempUser.semester = 1;
    if (role === 'Faculty') this.tempUser.subjects = undefined;
    this.showForm = true;
  }

  openAddCurrent(): void {
    this.openAddForRole(this.roleFilter as 'Admin' | 'Student' | 'Faculty');
  }

  countByRole(role: string): number {
    return this.users.filter(u => u.roles.includes(role)).length;
  }

  

  openEdit(user: User): void {
    this.editing = true;
    this.tempUser = { ...user };
    this.currentAddRole = (user.roles && user.roles.length) ? (user.roles[0] as 'Admin' | 'Student' | 'Faculty') : 'Admin';
    this.showForm = true;
  }

  closeForm(): void {
    this.showForm = false;
    this.tempUser = {};
  }

  saveUser(): void {
    const t = this.tempUser as User;

    if (!t.name || !t.email) {
      alert('Please provide name and email.');
      return;
    }
    if (!this.isValidEmail(t.email)) {
      alert('Please enter a valid email address.');
      return;
    }

    if (!this.editing && !t.password) {
      alert('Please provide a password.');
      return;
    }

    const role = this.editing ? (t.roles && t.roles.length ? t.roles[0] : this.currentAddRole) : (this.currentAddRole || this.roleFilter);
    if (role === 'Faculty') {
      if (!t.subjects) {
        alert('Please select a subject for the faculty.');
        return;
      }
      if (!t.department) {
        alert('Please select a department for the faculty.');
        return;
      }
    }

    this.loading = true;

    if (this.editing && t.id !== undefined) {
      const payload: Partial<User> & { roles: string[] } = {
        ...t,
        roles: this.tempUser.roles || [this.currentAddRole]
      };

      if (t.department) payload.department = t.department;

      this.userService.update(t.id, payload).subscribe({
          next: () => {
          this.loading = false;
          this.closeForm();
          this.loadUsers();
        },
          error: (err: any) => {
            console.error('Failed to update user', err);
            alert('Failed to update user.');
            this.loading = false;
          }
      });
    } else {
      const payload: Partial<User> & { roles: string[] } = {
        ...t,
        roles: [role],
        status: t.status || 'Active',
        semester: role === 'Student' ? ((t as any).semester || 1) : undefined,
        department: t.department || undefined
      };

      this.userService.create(payload).subscribe({
          next: (res:any) => {
            if(role === 'Student')
            {
              this.feeService.createFee({
                user_id : res.user_id,
                total_fee : t.fees || 0,
                semester : 'All'
              }).subscribe({next: (res : any) => (console.log(res))});
            }
          this.loading = false;
          this.closeForm();
          this.loadUsers();
        },
          error: (err: any) => {
            console.error('Failed to create user', err);
            alert('Failed to create user.');
            this.loading = false;
          }
      });
    }
  }

  private isValidEmail(email: string | undefined): boolean {
    if (!email) return false;
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  deleteUser(id?: number | string): void {
    if (!id) return;
    if (!confirm('Delete this user?')) return;
    this.loading = true;
    this.userService.delete(id).subscribe({
      next: () => {
        this.loading = false;
        this.loadUsers();
      },
      error: (err: any) => {
        console.error('Failed to delete user', err);
        alert('Failed to delete user.');
        this.loading = false;
      }
    });
  }

  toggleRole(role: string): void {
    const t = this.tempUser as User;
    if (!t.roles) t.roles = [];
    const i = t.roles.indexOf(role);
    if (i === -1) t.roles.push(role);
    else t.roles.splice(i, 1);
  }
}
